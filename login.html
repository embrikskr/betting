<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin – Bet Tracker</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="lib/supabase.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="wrap" style="display:flex;align-items:center;gap:16px">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Adminpanel</h1>
          <p class="muted">Legg inn single og combo-kuponger</p>
        </div>
      </div>
      <div style="margin-left:auto">
        <a class="btn ghost" href="index.html">← Til oversikten</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="loginBox" class="panel">
      <h2>Logg inn</h2>
      <div class="form-grid two">
        <div class="field">
          <label for="email">E-post</label>
          <input id="email" type="email" placeholder="admin@example.com" autocomplete="username">
        </div>
        <div class="field">
          <label for="password">Passord</label>
          <input id="password" type="password" placeholder="123456" autocomplete="current-password">
        </div>
      </div>
      <div class="right">
        <button id="loginBtn" class="btn">Logg inn</button>
      </div>
      <p id="loginError" class="muted" style="color:#fca5a5"></p>
    </section>

    <section id="adminPanel" class="panel hidden">
      <h2>Ny kupong</h2>
      <form id="ticketForm" class="form-grid">
        <div class="field">
          <label for="date">Dato</label>
          <input type="date" id="date" required>
        </div>
        <div class="field">
          <label for="stake">Innsats</label>
          <input type="text" id="stake" inputmode="decimal" placeholder="800" required>
        </div>
        <div class="field">
          <label for="type">Type</label>
          <select id="type">
            <option value="single">Single</option>
            <option value="combo">Combo</option>
          </select>
        </div>
        <div class="field full">
          <label for="note">Notat (valgfritt)</label>
          <textarea id="note" rows="2" placeholder="Ekstra info"></textarea>
        </div>
      </form>

      <h3>Legger til spill (legs)</h3>
      <div id="legsBox"></div>
      <div class="controls mt-1">
        <button id="addLegBtn" class="btn">+ Legg til leg</button>
        <button id="saveTicketBtn" class="btn">Lagre kupong</button>
      </div>

      <h2 class="mt-2">Kuponger</h2>
      <div id="adminTickets" class="ticket-list"></div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <button id="logoutBtn" class="btn ghost hidden">Logg ut</button>
    </div>
  </footer>

  <script>
    // ===== HJELPERE =====
    const ADMIN_UIDS = window.APP_CONFIG.ADMIN_UIDS || [];
    function normNum(v) { return typeof v === 'number' ? v : parseFloat(String(v).replace(',', '.')); }
    function round2(x) { return Math.round((x + Number.EPSILON) * 100) / 100; }
    const fmt = new Intl.NumberFormat('no-NO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // ===== LOGIKK =====
    function settleStatus(legs){ if(legs.some(l=>l.status==='loss')) return 'loss'; if(legs.length>0 && legs.every(l=>l.status==='win')) return 'win'; return 'pending'; }
    function totalOdds(legs){ return legs.reduce((acc,l)=> acc * normNum(l.odds), 1); }
    function profitFor(t, legs){ const s=settleStatus(legs); const stake=normNum(t.stake); const odds=totalOdds(legs); if(s==='win') return stake*(odds-1); if(s==='loss') return -stake; return 0; }
    function isAdminSession(session){ const uid=session?.user?.id; return !!uid && ADMIN_UIDS.includes(uid); }
    function pill(s){ const c=s==='win'?'win':s==='loss'?'loss':'pending'; const t=s==='win'?'Vunnet':s==='loss'?'Tapt':'Åpen'; return `<span class="pill ${c}">${t}</span>`; }

    function legRow(data={}){
      const wrap = document.createElement('div');
      wrap.className = 'form-grid';
      wrap.innerHTML = `
        <div class="field"><label>Bookie</label><input class="lg-bookie" type="text" placeholder="Bet365" value="${data.bookie||''}" required></div>
        <div class="field"><label>Event</label><input class="lg-event" type="text" placeholder="PSG – OM" value="${data.event||''}" required></div>
        <div class="field"><label>Valg</label><input class="lg-pick" type="text" placeholder="Over 2.5" value="${data.pick||''}" required></div>
        <div class="field"><label>Odds</label><input class="lg-odds" type="text" inputmode="decimal" placeholder="1.85" value="${data.odds||''}" required></div>
        <div class="field"><label>Status</label>
          <select class="lg-status">
            <option value="pending" ${(data.status||'pending')==='pending'?'selected':''}>Åpen</option>
            <option value="win" ${(data.status||'pending')==='win'?'selected':''}>Vunnet</option>
            <option value="loss" ${(data.status||'pending')==='loss'?'selected':''}>Tapt</option>
          </select>
        </div>
        <div class="field"><label>&nbsp;</label><button class="btn ghost del" type="button">Slett</button></div>
      `;
      wrap.querySelector('.del').addEventListener('click', ()=> wrap.remove());
      return wrap;
    }

    function readLegs(){
      return [...document.querySelectorAll('#legsBox .form-grid')].map(row=> ({
        bookie: row.querySelector('.lg-bookie').value.trim(),
        event:  row.querySelector('.lg-event').value.trim(),
        pick:   row.querySelector('.lg-pick').value.trim(),
        odds:   normNum(row.querySelector('.lg-odds').value),
        status: row.querySelector('.lg-status').value
      })).filter(l => l.bookie && l.event && l.pick && isFinite(l.odds));
    }

    async function loadAll(){
      const { data: bets } = await sb.from('bets').select('*').order('date',{ascending:false}).order('created_at',{ascending:false});
      const ids = (bets||[]).map(b=> b.id);
      const { data: legs } = ids.length ? await sb.from('bet_legs').select('*').in('bet_id', ids) : { data: [] };
      const byBet = {}; (legs||[]).forEach(l=> (byBet[l.bet_id]=byBet[l.bet_id]||[]).push(l));
      return (bets||[]).map(b=> ({ ticket:b, legs: byBet[b.id]||[] }));
    }

    async function renderAdmin(){
      const items = await loadAll();
      const list = document.getElementById('adminTickets'); list.innerHTML='';
      items.forEach(({ticket, legs})=>{
        const st = settleStatus(legs);
        const odds = totalOdds(legs);
        const payout = normNum(ticket.stake) * odds;
        const prof = profitFor(ticket, legs);

        const el = document.createElement('div'); el.className='ticket';
        el.innerHTML = `
          <div class="ticket-head">
            ${pill(st)}
            <div class="kv"><span class="k">Dato</span><span class="v">${ticket.date}</span></div>
            <div class="kv"><span class="k">Type</span><span class="v">${ticket.type==='combo'?'Combo':'Single'}</span></div>
            <div class="kv"><span class="k">Total odds</span><span class="v">${odds.toFixed(2)}</span></div>
            <div class="kv"><span class="k">Innsats</span><span class="v">${fmt.format(round2(normNum(ticket.stake)))}</span></div>
            <div class="kv"><span class="k">Utbetaling</span><span class="v">${st==='pending'?'—':fmt.format(round2(payout))}</span></div>
            <div class="kv"><span class="k">Profit</span><span class="v">${st==='pending'?'—':((prof>=0?'+':'')+fmt.format(round2(prof)))}</span></div>
            <div class="right">
              <button class="btn ghost" data-toggle>Detaljer</button>
              <button class="btn ghost del" data-del="${ticket.id}">Slett</button>
            </div>
          </div>
          <div class="ticket-body">
            ${(ticket.note ? `<p class="muted">${ticket.note}</p>`: '')}
            <table class="legs"><thead><tr><th>Bookie</th><th>Event</th><th>Valg</th><th>Odds</th><th>Status</th></tr></thead>
              <tbody>${legs.map(l=>`<tr><td>${l.bookie}</td><td>${l.event}</td><td>${l.pick}</td><td>${normNum(l.odds).toFixed(2)}</td><td>
                <select data-leg="${l.id}">
                  <option value="pending" ${l.status==='pending'?'selected':''}>Åpen</option>
                  <option value="win" ${l.status==='win'?'selected':''}>Vunnet</option>
                  <option value="loss" ${l.status==='loss'?'selected':''}>Tapt</option>
                </select>
              </td></tr>`).join('')}</tbody>
            </table>
          </div>
        `;
        el.querySelector('[data-toggle]').addEventListener('click', ()=> el.classList.toggle('open'));
        el.querySelectorAll('select[data-leg]').forEach(sel=>{
          sel.addEventListener('change', async e=>{
            const id=e.target.getAttribute('data-leg');
            const status=e.target.value;
            const { error } = await sb.from('bet_legs').update({ status }).eq('id', id);
            if(error){ alert('Kunne ikke oppdatere leg: '+error.message); return; }
            renderAdmin();
          });
        });
        el.querySelector('[data-del]').addEventListener('click', async ()=>{
          if(!confirm('Slette kupong?')) return;
          await sb.from('bets').delete().eq('id', ticket.id);
          renderAdmin();
        });
        list.appendChild(el);
      });
    }

    // ===== UI-handlers =====
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('loginBtn').addEventListener('click', async ()=>{
        const email=document.getElementById('email').value.trim();
        const password=document.getElementById('password').value;
        const err=document.getElementById('loginError'); err.textContent='';
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if(error){ err.textContent=error.message; return; }
        if(!isAdminSession(data.session)){ err.textContent='Ikke autorisert (feil bruker).'; await sb.auth.signOut(); return; }
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('adminPanel').classList.remove('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        renderAdmin();
      });

      document.getElementById('logoutBtn').addEventListener('click', async ()=>{ await sb.auth.signOut(); location.reload(); });

      document.getElementById('addLegBtn').addEventListener('click', ()=>{
        document.getElementById('legsBox').appendChild(legRow());
      });

      document.getElementById('saveTicketBtn').addEventListener('click', async ()=>{
        const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
        const stake = normNum(document.getElementById('stake').value);
        const type  = document.getElementById('type').value;
        const note  = (document.getElementById('note').value || '').trim() || null;
        const legs  = readLegs();
        if(!isFinite(stake) || stake<=0 || legs.length===0){ alert('Fyll inn innsats og minst én leg.'); return; }

        const payload = { date, stake, type, status:'pending' };
        if (note) payload.note = note; // bare send note hvis skrevet

        const { data: insBet, error: e1 } = await sb.from('bets').insert([payload]).select();
        if(e1){ alert('Kunne ikke lagre kupong: ' + e1.message); return; }
        const betId = insBet[0].id;

        const legsPayload = legs.map(l=> ({ ...l, bet_id: betId }));
        const { error: e2 } = await sb.from('bet_legs').insert(legsPayload);
        if(e2){ alert('Kunne ikke lagre legs: ' + e2.message); return; }

        document.getElementById('ticketForm').reset();
        document.getElementById('legsBox').innerHTML='';
        document.getElementById('legsBox').appendChild(legRow()); // start med én igjen
        renderAdmin();
      });

      // start med én leg klar
      document.getElementById('legsBox').appendChild(legRow());
    });
  </script>
</body>
</html>
