<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bet Tracker</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="lib/supabase.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="wrap" style="display:flex;align-items:center;gap:16px">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Bet Tracker</h1>
          <p class="muted">Single og combo-kuponger</p>
        </div>
      </div>
      <div style="margin-left:auto">
        <a class="btn" href="login.html">Logg inn</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="cards">
      <div class="card">
        <h2>Resultat (avsluttede kuponger)</h2>
        <div id="mProfit" class="metric">+0,00</div>
        <p class="muted">Sum gevinst/tap</p>
      </div>
    </section>

    <section class="panel">
      <div id="tickets" class="ticket-list"></div>
    </section>
  </main>

  <script>
    // ===== HJELPERE: korrekt parsing og avrunding =====
    function normNum(v) { return typeof v === 'number' ? v : parseFloat(String(v).replace(',', '.')); }
    function round2(x) { return Math.round((x + Number.EPSILON) * 100) / 100; }
    const fmt = new Intl.NumberFormat('no-NO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // ===== LOGIKK: status, totalodds, profit =====
    function settleStatus(legs) {
      if (legs.some(l => l.status === 'loss')) return 'loss';
      if (legs.length > 0 && legs.every(l => l.status === 'win')) return 'win';
      return 'pending';
    }
    function totalOdds(legs) {
      // Ikke rund her – eksakt produkt
      return legs.reduce((acc, l) => acc * normNum(l.odds), 1);
    }
    function profitFor(ticket, legs) {
      const s = settleStatus(legs);
      const stake = normNum(ticket.stake);
      const odds = totalOdds(legs);
      if (s === 'win') return stake * (odds - 1);
      if (s === 'loss') return -stake;
      return 0;
    }

    function pill(status){
      const cls = status==='win'?'win':status==='loss'?'loss':'pending';
      const txt = status==='win'?'Vunnet':status==='loss'?'Tapt':'Åpen';
      return `<span class="pill ${cls}">${txt}</span>`;
    }

    async function loadTickets(){
      const { data: bets, error } = await sb.from('bets').select('*').order('date',{ascending:false}).order('created_at',{ascending:false});
      if(error){ console.error(error); return []; }
      const ids = (bets||[]).map(b=> b.id);
      if(ids.length===0) return [];
      const { data: legs, error: e2 } = await sb.from('bet_legs').select('*').in('bet_id', ids);
      if(e2){ console.error(e2); return []; }
      const byBet = {}; (legs||[]).forEach(l=> (byBet[l.bet_id]=byBet[l.bet_id]||[]).push(l));
      return (bets||[]).map(b=> ({ ticket:b, legs: (byBet[b.id]||[]) }));
    }

    function renderTickets(items){
      const list = document.getElementById('tickets'); list.innerHTML='';
      items.forEach(({ticket, legs})=>{
        const st = settleStatus(legs);
        const odds = totalOdds(legs);
        const profit = profitFor(ticket, legs);
        const payout = normNum(ticket.stake) * odds;

        const el = document.createElement('div'); el.className='ticket';
        el.innerHTML = `
          <div class="ticket-head">
            ${pill(st)}
            <div class="kv"><span class="k">Dato</span><span class="v">${ticket.date}</span></div>
            <div class="kv hide-sm"><span class="k">Type</span><span class="v">${ticket.type==='combo'?'Combo':'Single'}</span></div>
            <div class="kv"><span class="k">Total odds</span><span class="v">${odds.toFixed(2)}</span></div>
            <div class="kv"><span class="k">Innsats</span><span class="v">${fmt.format(round2(normNum(ticket.stake)))}</span></div>
            <div class="kv"><span class="k">Utbetaling</span><span class="v">${st==='pending'?'—':fmt.format(round2(payout))}</span></div>
            <div class="kv"><span class="k">Profit</span><span class="v">${st==='pending'?'—':((profit>=0?'+':'')+fmt.format(round2(profit)))}</span></div>
            <div class="right"><button class="btn ghost" data-toggle>Detaljer</button></div>
          </div>
          <div class="ticket-body">
            ${ticket.note ? `<p class="muted">${ticket.note}</p>`:''}
            <table class="legs">
              <thead><tr><th>Bookie</th><th>Event</th><th>Valg</th><th>Odds</th><th>Status</th></tr></thead>
              <tbody>
                ${legs.map(l=>`<tr>
                  <td>${l.bookie}</td>
                  <td>${l.event}</td>
                  <td>${l.pick}</td>
                  <td>${normNum(l.odds).toFixed(2)}</td>
                  <td>${pill(l.status)}</td>
                </tr>`).join('')}
              </tbody>
            </table>
          </div>
        `;
        el.querySelector('[data-toggle]').addEventListener('click', ()=> el.classList.toggle('open'));
        list.appendChild(el);
      });

      // total resultat for avsluttede kuponger
      const total = items
        .filter(x=> settleStatus(x.legs)!=='pending')
        .reduce((s,x)=> s + profitFor(x.ticket, x.legs), 0);
      const mp=document.getElementById('mProfit');
      mp.textContent=(total>=0?'+':'')+fmt.format(round2(total));
      mp.classList.toggle('good', total>0);
      mp.classList.toggle('bad', total<0);
    }

    (async()=>{ const items=await loadTickets(); renderTickets(items); })();
  </script>
</body>
</html>
